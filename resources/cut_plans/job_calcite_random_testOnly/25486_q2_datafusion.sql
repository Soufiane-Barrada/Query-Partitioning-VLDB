SELECT COALESCE("t7"."PRODUCTION_YEAR", "t7"."PRODUCTION_YEAR") AS "PRODUCTION_YEAR", "t7"."MOVIE_KIND", "t7"."TOTAL_MOVIES", "t7"."UNIQUE_ACTORS", "t7"."TOTAL_ROLES", "t7"."TOTAL_PRODUCTION_COMPANIES", "t7"."ALL_KEYWORDS"
FROM (SELECT "t5"."PRODUCTION_YEAR", "kind_type"."kind" AS "MOVIE_KIND", "t5"."TOTAL_MOVIES", "t5"."UNIQUE_ACTORS", "t5"."TOTAL_ROLES", "t5"."TOTAL_PRODUCTION_COMPANIES", "t5"."ALL_KEYWORDS"
FROM "IMDB"."kind_type"
INNER JOIN (SELECT "t4"."PRODUCTION_YEAR", "t4"."KIND_ID", COUNT(DISTINCT "t4"."TITLE") AS "TOTAL_MOVIES", COUNT(DISTINCT "t4"."ACTOR_NAME") AS "UNIQUE_ACTORS", SUM("t4"."NUM_ROLES") AS "TOTAL_ROLES", SUM("t4"."NUM_PRODUCTION_COMPANIES") AS "TOTAL_PRODUCTION_COMPANIES", LISTAGG(DISTINCT "t4"."KEYWORDS", "t4"."$f7") AS "ALL_KEYWORDS"
FROM (SELECT "s1"."production_year" AS "PRODUCTION_YEAR", "s1"."kind_id" AS "KIND_ID", "s1"."title" AS "TITLE", ANY_VALUE("s1"."name") AS "ACTOR_NAME", SUM(1) AS "NUM_ROLES", COUNT(DISTINCT "movie_companies"."company_id") AS "NUM_PRODUCTION_COMPANIES", LISTAGG(DISTINCT "keyword"."keyword", ', ') AS "KEYWORDS", ', ' AS "$f7"
FROM "s1"
LEFT JOIN "IMDB"."keyword" ON "s1"."keyword_id" = "keyword"."id"
LEFT JOIN "IMDB"."movie_companies" ON "s1"."id" = "movie_companies"."movie_id"
GROUP BY "s1"."id", "s1"."title", "s1"."production_year", "s1"."kind_id", "s1"."name", "s1"."person_id0") AS "t4"
GROUP BY "t4"."PRODUCTION_YEAR", "t4"."KIND_ID") AS "t5" ON "kind_type"."id" = "t5"."KIND_ID"
ORDER BY "t5"."PRODUCTION_YEAR" DESC NULLS FIRST, "t5"."TOTAL_MOVIES" DESC NULLS FIRST) AS "t7"